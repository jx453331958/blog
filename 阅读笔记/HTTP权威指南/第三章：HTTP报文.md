# HTTP 权威指南

## 第 3 章 HTTP 报文

1. 报文流：HTTP 报文是在 HTTP 应用程序之间发送的数据块。这些数据块以一些文本形式的元信息开头，这些信息描述了报文的内容及含义，后面跟着可选的数据部分。这些报文在客户端、服务器和代理之间流动。

    1. HTTP 使用术语流入和流出来描述事务处理的方向。
    2. 不管是请求报文还是响应报文，所有报文都会向下游流动。所有报文的发送者都在接收者的上游。

2. 报文的组成部分：HTTP 报文是简单的格式化数据块。每条报文都包含一条来自客户端的请求，或者一条来自服务器的响应。它们由三个部分组成：对报文进行描述的起始行、包含属性的首部块，以及可选的、包含数据的主体部分。

    1. 起始行和首部就是由行分隔的 ASC2 文本。每行都以一个由两个字符组成的行终止序列作为结束，其中包含一个回车符和一个换行符。这个行终止序列可以写作 CRLF。
    2. 实体的主体或报文的主体是一个可选的数据块。与起始行和首部不同的是，主体中可以包含二进制数据，也可以为空。
    3. 所有的 HTTP 报文都可以分为两类：请求报文和响应报文
    4. 请求报文的格式：

        ```
        <method> <request-URL> <version>
        <headers>

        <entity-body>
        ```

    5. 响应报文的格式

        ```
        <version> <status> <reason-phrase>
        <headers>

        <entity-body>
        ```

    6. 报文的语法描述：
        1. 方法：客户端希望服务器对资源执行的动作。
        2. 请求 URL：命名了所请求的资源
        3. 版本：报文所使用的 HTTP 版本
        4. 状态码：三位数字描述了请求过程中所发生的情况。
        5. 原因短语：数字状态码的可读版本，包含行终止序列之前的所有文本。
        6. 首部：可以有零个或多个首部，每个首部都包含一个名字，后面跟着一个冒号，然后是一个可选的空格，接着是一个值，最后是一个 CRLF。
        7. 实体的主体部分：包含一个由任意数据组成的数据块。
    7. 起始行：所有的 HTTP 报文都是以一个起始行作为开始，请求报文的起始行说明了要做些什么，响应报文的起始行说明了发生了什么。
    8. 状态码分类：
        1. 100 ～ 199: 信息提示
        2. 200 ～ 299: 成功
        3. 300 ～ 399: 重定向
        4. 400 ～ 499: 客户端错误
        5. 500 ～ 599: 服务器错误
    9. 常见状态码：
        1. 200: 请求成功
        2. 401: 未授权
        3. 404: 无法找到资源
    10. 首部：HTTP 首部字段向请求和响应报文中添加了一些附加信息。
        1. 通用首部：既可以出现在请求报文中，也可以出现在响应报文中。
        2. 请求首部：提供更多有关请求的信息。
        3. 响应首部：提供更多有关响应的信息。
        4. 实体首部：描述主体的长度和内容，或者资源本身。
        5. 扩展首部：规范中没有定义的新首部。
    11. 实体的主体部分：实体的主体是 HTTP 报文的负荷，就是 HTTP 要传输的内容。

3. 方法：并不是每一台服务器都实现了所有的方法。

    1. 安全方法：HTTP 定义了一组被称为安全方法的方法。GET 方法和 HEAD 方法都被认为是安全的，这就意味着使用 GET 或 HEAD 方法的 HTTP 请求都不会产生什么动作。不产生动作，在这里意味着 HTTP 请求不会在服务器上产生什么结果。但安全方法并不一定是什么动作都不执行，实际上这是由开发者决定的。使用安全方法的目的就是当使用可能引发某一动作的不安全方法时，允许 HTTP 应用程序开发者通知用户。
    2. GET：最常用的方法，通常用于请求服务器发送某个资源。
    3. HEAD：与 GET 的行为很类似，但服务器在响应中只返回首部。不会返回实体的主体部分。这就允许客户端在未获取实际资源的情况下，对资源的首部进行检查。
        1. 在不获取资源的情况下了解资源的情况，比如判断其类型
        2. 通过查看响应中的状态码，看看某个对象是否存在
        3. 通过查看首部，测试资源是否被修改了
    4. PUT：PUT 方法会向服务器写入文档。PUT 方法的语义就是让服务器用请求的主体部分来创建一个由所请求的 URL 命名的新文档，或者，如果那个 URL 已经存在的话，就用这个主体来替代它。
    5. POST：POST 方法是用来向服务器输入数据的。
    6. TRACE：客户端发起一个请求时，这个请求可能要穿过防火墙、代理、网关或其他一些应用程序。每个中间节点都可能会修改原始的 HTTP 请求。TRACE 方法允许客户端在最终将请求发送给服务器时，看看它变成了什么样子。TRACE 请求会在目的服务器发起一个“环回”诊断。行程最后一站的服务器回弹回一条 TRACE 响应，并在服务器主体中携带它收到的原始请求报文。这样客户端就可以查看在所有中间 HTTP 应用程序组成的请求/响应链上，原始报文是否，以及如何被毁坏或修改过。
    7. OPTIONS：OPTIONS 方法请求服务器告知其支持的各种功能。可以询问服务器通常支持哪些方法，或者对某些特殊资源支持哪些方法。
    8. DELETE：请服务器删除请求 URL 所指定的资源。

4. 状态码：状态码为客户端提供了一种理解事务处理结果的便捷方式。

    1. 100 ～ 199: 信息性状态码
        1. 100: Continue，说明收到了请求的初始部分，请客户端继续。该状态码主要用于如下情况：HTTP 客户端应用程序有一个实体的主体部分要发送给服务器，但希望在发送之前查看一下服务器是否会接受这个实体。
        2. 101: Switching Protocols，说明服务器正在根据客户端的指定，将协议切换成 Update 首部所列的协议。
    2. 200 ～ 299: 成功状态码
        1. 200: OK，请求没问题
        2. 201: Created，用于创建服务器对象的请求，例如 PUT
        3. 202: Accepted，请求已被接受，但服务器还未对其执行任何动作。不能保证服务器会完成这个请求，这只是意味着接受请求时，它看起来是有效的。
        4. 203: Non-Authoritative Information，实体首部包含的信息不是来自于源端服务器，而是来自资源的一份副本。
        5. 204: No Content，响应报文中包含若干首部和一个状态行，但没有实体的主体部分。
        6. 205: Reset Content，主要用于浏览器的代码。负责告知浏览器清除当前页面中的所有 HTML 表单元素。
        7. 206: Partial Content，成功执行了一个部分或范围请求。
    3. 300 ～ 399: 重定向状态码
        1. 300: Multiple Choices，客户端请求一个实际上指向多个资源的 URL 时会返回这个状态码，比如服务器上有某个 HTML 文档的英语和法语版本。返回这个代码时会带有一个选项列表，这样用户就可以选择他希望使用的那一项了。
        2. 301: Moved Permanently，永久重定向。
        3. 302: Found，临时重定向，客户端应该使用 Location 首部给出的 URL 来临时定位资源，将来的请求仍是使用老 URL。
        4. 303: See Other，告知客户端应该用另一个 URL 来获取资源。新的 URL 位于 Location 首部，其主要目的是允许 POST 的响应将客户端定向到某个资源上去。
        5. 304: Not Modified，条件请求，说明资源未被修改过。
        6. 305: Use Proxy，用来说明必须通过一个代理来访问资源，代理的位置由 Location 首部给出。
        7. 307: Temporary Redirect，临时重定向，同 302，客户端应该使用 Location 首部给出的 URL 来临时定位资源，将来的请求仍是使用老 URL。
    4. 400 ～ 499: 客户端错误状态码
        1. 400: Bad Request，告知客户端发送了一个错误的请求。
        2. 401: Unauthorized，无权限。
        3. 402: Payment Required，还未使用，被保留。
        4. 403: Forbidden，请求被服务器拒绝了。
        5. 404: Not Found
        6. 405: Method Not Allowed，发起的请求中带有所请求的 URL 不支持的方法。
        7. 406: Not Acceptable，客户端可以指定参数来说明它们愿意接收什么类型的实体。服务器没有与客户端可接受的 URL 相匹配的资源时，使用此状态码。
        8. 407: Proxy Authentication Required，与 401 类似，但用于要求对资源进行认证的代理服务器。
        9. 408: Request Timeout，如果客户端完成请求所花的时间太长，服务器可以回送此状态码，并关闭连接。
        10. 409: Conflict，用于说明请求可能在资源上引发一些冲突。服务器担心请求会引发冲突时，可以回送此状态码。
        11. 410: Gone，与 404 类似，只是服务器曾经拥有过此资源。
        12. 411: Length Required，服务器要求在请求报文中包含 Content-Length 首部时使用。
        13. 412: Precondition Failed，客户端发起了条件请求，且其中一个条件失败了的时候使用。
        14. 413: Request Entity Too Large，客户端发送的实体主体部分比服务器能够或者希望处理的要大。
        15. 414: Request URI Too Long，客户端发送的请求 URL 过长。
        16. 415: Unsupported Media Type，服务器无法支持所发实体的内容类型。
        17. 416: Requested Range Not Satisfiable，请求报文所请求的是指定资源的某个范围，而此范围无效或无法满足。
        18. 417: Expecation Failed，请求的 Expect 请求首部包含了一个期望，但是服务器无法满足此期望。
    5. 500 ～ 599:服务器错误状态码
        1. 500: Internal Server Error，服务器内部错误
        2. 501: Not Implemented，客户端发起的请求超出服务器的能力范围，例如使用了服务器不支持的请求方法。
        3. 502: Bad Gateway，作为代理或网关使用的服务器从请求响应链的下一条链路上收到了一条伪响应。
        4. 503: Service Unavailable，服务器现在无法为请求提供服务。
        5. 504: Gateway Timeout，与状态码 408 类似，只是这里的响应来自一个网关或代理，它们在等待另一服务器对其请求进行响应时超时了。
        6. 505: HTTP Version Not Supported，服务器收到的请求使用了它无法或不愿支持的协议版本。

5. 首部：首部和方法配合使用，共同决定了客户端和服务器能做什么事情。
    1. 首部有 5 个主要的类型：
        1. 通用首部：客户端和服务器都可以使用的首部
        2. 请求首部：请求报文特有的
        3. 响应首部：响应报文特有的，以便为客户端提供信息
        4. 实体首部：用于应对实体主体部分的首部，比如可以用来说明实体主体部分的数据类型
        5. 扩展首部：非标准的首部，由应用程序开发者创建
    2. 通用的信息性首部：
        1. Connection：允许客户端和服务器指定与请求/响应连接有关的选项
        2. Date：提供日期和时间标志，说明报文是什么时间创建的
        3. MIME-Version：给出了发送端使用的 MIME 版本
        4. Trailer：如果报文采用了分块传输编码方式，就可以用这个首部列出位于报文拖挂部分的首部集合
        5. Transfer-Encoding：告知接收端为了保证报文的可靠传输，对报文采用了什么编码方式
        6. Update：给出了发送端可能想要“升级”使用的新版本或协议
        7. Via：显示了报文经过的中间节点（代理，网关）
    3. 通用缓存首部：
        1. Cache-Control：用于随报文传送缓存指示
        2. Pragma：另一种随报文传送指示的方式，但并不专用于缓存
    4. 请求的信息性首部：
        1. Client-IP：客户端机器 IP
        2. From：客户端用户的 E-mail 地址
        3. Host：接收请求的服务器的主机名和端口号
        4. Referer：包含当前请求 URI 的文档的 URL
        5. UA-Color：提供了客户端显示器的显示颜色有关的信息
        6. UA-CPU：CPU 类型或制造商
        7. UA-Disp：客户端显示器能力相关信息
        8. UA-OS：客户端操作系统
        9. UA-Pixels：客户端显示器的像素信息
        10. User-Agent：应用程序名称
    5. Accept 首部：为客户端提供了一种将其喜好和能力告知服务器的方式，请求中使用
        1. Accept：告诉服务器能够发送哪些媒体类型
        2. Accept-Charset：告诉服务器能够发送哪些字符集
        3. Accept-Encoding：告诉服务器能够发送哪些编码方式
        4. Accept-Language：告诉服务器能够发送哪些语言
        5. TE：告诉服务器能够使用哪些扩展传输编码
    6. 条件请求首部：为请求加上某些限制。
        1. Expect：允许客户端列出某请求所要求的服务器行为
        2. If-Match：如果实体标记与文档当前的实体标记相匹配，就获取这份文档
        3. If-Modified-Since：除非在某个指定的日期之后资源被修改过，否则就限制这个请求
        4. If-None-Match：如果提供的实体标记与当前文档的实体标记不相符，就获取文档。
        5. If-Range：允许对文档的某个范围进行条件请求
        6. If-Unmodified-Since：除非在某个指定日期之后资源没有被修改过，否则就限制这个请求
        7. Range：如果服务器支持范围请求，就请求资源的指定范围
    7. 安全请求首部：客户端在获取特定的资源之前，先对自身进行认证。
        1. Authorization：包含了客户端提供给服务器以便对其自身进行认证的数据。
        2. Cookie：客户端的一个令牌
        3. Cookie2：用来说明请求端支持的 cookie 版本
    8. 代理请求首部：
        1. Max-Forward：在通往源端服务器的路径上，将请求转发给其他代理或网关的最大次数，与 TRACE 方法一同使用。
        2. Proxy-Authorization：与 Authorization 首部相同，但这个首部是在与代理进行认证时使用的
        3. Proxy-Connection：与 Connection 首部相同，但这个首部是在与代理建立连接时使用的
    9. 响应的信息性首部：
