# 深入浅出 NodeJS

## 第 1 章 Node 简介

1. 设计高性能，Web 服务器的几个要点：事件驱动、非阻塞 I/O

2. Node 的特点：

   1. 异步 I/O：Node 在底层构建了很多异步 I/O 的 API，从文件读取到网络请求等。这样的意义在于我们可以从语言层面很自然地进行并行 I/O 操作。每个调用之间无需等待之前的 I/O 调用结束。在编程模型上可以极大提升效率。
   2. 事件与回调函数：事件的编程方式具有轻量级、松耦合、只关注事务点等优势，但是在多个异步任务的场景下，事件与事件之间各自独立，如何协作是一个问题。
   3. 单线程：Node 保持了 JavaScript 在浏览器中单线程的特点。在 Node 中，JavaScript 与其余线程是无法共享任何状态的。单线程的最大好处是不用像多线程编程那样处处在意状态的同步问题，这里没有死锁的存在，也没有线程上下文交换所带来的性能开销。单线程也有一些弱点：
      1. 无法利用多核 CPU
      2. 错误会引起整个应用退出，应用的健壮性值得考验
      3. 大量计算占用 CPU 导致无法继续调用异步 I/O
   4. 跨平台：Node 基于 libuv 实现跨平台，可以在 Linux 和 Windows 上运行。

3. 在 Node 中，长时间的 CPU 占用也会导致后续的异步 I/O 发不出调用，已完成的异步 I/O 的回调函数也会得不到执行。Node 采用了与 Web Workers 相同的思路来解决单线程中大计算量的问题：child_process。子进程的出现，意味着 Node 可以从容地应对单线程在健壮性和无法利用多核 CPU 方面的问题。通过将计算分发到各个子进程，可以将大量的计算分解掉，然后再通过进程之间的事件消息来传递结果，可以很好地保持应用模型的简单和低依赖。

4. Node 的应用场景：

   1. I/O 密集型：Node 面向网络且擅长并行 I/O，能够有效地组织起更多的硬件资源，从而提供更好的服务。I/O 密集的优势主要在于 Node 利用事件循环的能力，而不是启动每一个线程为每一个请求服务，资源占用极少。
   2. 是否不擅长 CPU 密集型业务：实际上 V8 的效率很高。CPU 密集型应用给 Node 带来的挑战主要是，由于 JavaScript 单线程的原因，如果有长时间运行的计算，将会导致 CPU 时间片不能释放，使得后续 I/O 无法发起。但是适当调整和分解大型运算任务为多个小人物，使得运算能够适时释放，不阻塞 I/O 调用的发起，这样既可以同时享受到并行异步 I/O 的好处，又能充分利用 CPU。
   3. 与遗留系统和平共处：Node 作为中间层，调用后端服务。
   4. 分布式应用

5. 关于 CPU 密集型应用，Node 的异步 I/O 已经解决了在单线程上 CPU 与 I/O 之间阻塞无法重叠利用的问题，I/O 阻塞造成的性能浪费远比 CPU 的影响小。对于长时间运行的计算，如果它的耗时远超过普通阻塞 I/O 的耗时，那么应用场景就需要重新评估，因为这类计算比阻塞 I/O 还影响效率，甚至说是一个纯计算的场景，根本没有 I/O。此类场景应该采用多线程的方式进行计算。
