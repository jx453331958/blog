# 深入浅出 NodeJS

## 第 6 章 理解 Buffer

1. Buffer 是一个像 Array 的对象，但它主要用于操作字节。Buffer 是一个典型的 Javascript 与 C++结合的模块，它将性能相关部分用 C++实现，将非性能相关的部分用 Javascript 实现。

2. Buffer 对象类似于数组，它的元素为 16 进制的两位数，即 0 到 255 的数值。

3. 给 Buffer 的元素赋值：给元素的赋值如果小于 0，就将该值逐次加 256，直到得到一个 0 到 255 之间的整数。如果得到的数值大于 255，就逐次减 256，直到得到 0-255 区间内的数值。如果是小数，舍弃小数部分，只保留整数部分。

4. Buffer 内存分配：Buffer 对象的内存分配不是在 V8 的堆内存中，而是在 Node 的 C++层面实现内存申请的。因为处理大量的字节数据不能采用需要一点内存就向操作系统申请一点内存的方式，这可能造成大量的内存申请的系统调用，对操作系统有一定压力。

5. 为了高效地使用申请来的内存，Node 采用了 slab 分配机制。slab 是一种动态内存管理机制。slab 具有三种状态

   1. full：完全分配状态
   2. partial：部分分配状态
   3. empty：没有被分配状态

6. Buffer 对象可以与字符串之间相互转换。目前支持的字符串类型有：

   1. ASC2
   2. UTF-8
   3. UTF-16LE/UCS-2
   4. Base64
   5. Binary
   6. Hex

7. 字符串转 Buffer 对象主要是通过构造函数完成的，通过构造函数转换的 Buffer 对象，存储的只能是一种编码类型。一个 Buffer 对象可以存储不同编码类型的字符串转码的值。由于可以不断写入内容到 Buffer 对象中，并且每次写入可以指定编码，所以 Buffer 对象中可以存在多种编码转化后的内容。

8. Buffer 转字符串：调用 Buffer 对象的 toString()方法。

9. Buffer 的拼接：正确的拼接方式是用一个数组来存储收到的所有 Buffer 片段并记录下所有片段的总长度。然后调用 Buffer.concat()方法生成一个合并的 Buffer 对象。Buffer.concat()方法封装了从小 Buffer 对象向大 Buffer 对象的复制过程。
